<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Mapa Interativo do 36º BPM</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    /* botão flutuante sempre visível */
    .locate-btn {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 10000;           /* acima do mapa e popups */
      background: #111;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .locate-btn:active { transform: scale(0.98); }

    /* melhora toque em celulares */
    .leaflet-container { touch-action: pan-x pan-y; }
  </style>
</head>
<body>
  <div id="map"></div>
  <button class="locate-btn" id="btnLocate">Minha localização</button>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // mapa base
    const map = L.map('map', { zoomControl: true });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // grupo para ajustar enquadramento
    const group = L.featureGroup().addTo(map);

    // estilo padrão dos subsetores (bem destacado)
    function baseStyle() {
      return {
        color: '#000000',        // borda preta
        weight: 3.5,             // borda grossa
        opacity: 1,
        fillColor: '#7a7a7a',    // cinza
        fillOpacity: 0.25
      };
    }

    // carregamento do GeoJSON local
    fetch('subsetores-36bpm.json')
      .then(r => r.json())
      .then(data => {
        const layer = L.geoJSON(data, {
          style: baseStyle,
          onEachFeature: (feat, lyr) => {
            const p = feat.properties || {};
            const titulo = p.descrição || p.name || 'Subsetor';
            const cia = p.CIA ? `<div><b>CIA:</b> ${p.CIA}</div>` : '';
            const codigo = p.CODIGO ? `<div><b>Código:</b> ${p.CODIGO}</div>` : '';
            const ueop = p.UEOP_2 ? `<div><b>Unidade:</b> ${p.UEOP_2}</div>` : '';

            lyr.bindTooltip(titulo, { sticky: true });
            lyr.on('click', () => {
              lyr.bindPopup(`<b>${titulo}</b>${codigo}${cia}${ueop}`, { maxWidth: 280 }).openPopup();
            });

            // realce no hover (ajuda na divisa)
            lyr.on('mouseover', () => lyr.setStyle({ weight: 5, fillOpacity: 0.35 }).bringToFront());
            lyr.on('mouseout',  () => lyr.setStyle(baseStyle()));
          }
        }).addTo(group);

        // enquadra todos os subsetores
        map.fitBounds(layer.getBounds(), { padding: [20,20] });
      })
      .catch(err => console.error('Erro ao carregar subsetores:', err));

    // botão minha localização (sempre visível)
    document.getElementById('btnLocate').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocalização não suportada neste dispositivo.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const latlng = [pos.coords.latitude, pos.coords.longitude];
          L.marker(latlng).addTo(map)
            .bindPopup('Você está aqui').openPopup();
          map.setView(latlng, Math.max(map.getZoom(), 14));
        },
        err => {
          const msgs = {
            1: 'Permissão negada para acessar localização.',
            2: 'Posição indisponível.',
            3: 'Tempo esgotado ao obter localização.'
          };
          alert(msgs[err.code] || 'Não foi possível obter sua localização.');
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    });

    // PWA (mantém seu sw.js atual)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
