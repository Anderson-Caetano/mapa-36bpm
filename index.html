<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa 36º BPM</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b5ed7" />
  <link rel="icon" href="logo-36.png" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar{
      position:fixed; left:8px; top:8px; z-index:1000;
      background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15);
      padding:8px; display:flex; gap:8px; align-items:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .topbar input{ width:180px; padding:6px 8px; border:1px solid #ccc; border-radius:6px; }
    .topbar button{ padding:6px 10px; border:0; border-radius:6px; background:#0b5ed7; color:#fff; cursor:pointer; }
    .leaflet-container .locate-btn{
      background:#0b5ed7; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- UI: busca rápida por coordenadas -->
  <div class="topbar">
    <strong>36º BPM</strong>
    <input id="lat" type="text" placeholder="-19.70" />
    <input id="lng" type="text" placeholder="-43.93" />
    <button id="btnIr">Ir</button>
    <button id="btnLoc" class="locate-btn">Minha posição</button>
  </div>

  <script>
    // Mapa base
    const map = L.map('map', { zoomControl: true }).setView([-19.7, -43.93], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    // Pane para garantir que os polígonos fiquem acima dos tiles
    map.createPane('polygons');
    map.getPane('polygons').style.zIndex = 650;

    let geoLayer = null;
    let userMarker = null;

    // Estilo de destaque (igual ao da sua imagem 2: borda escura + preenchimento cinza translúcido)
    const styleBase = {
      color: '#222',
      weight: 2,
      fillColor: '#777',
      fillOpacity: 0.25
    };

    // Carrega o GeoJSON (na RAIZ do repo!)
    fetch('subsetores-36bpm.json')
      .then(r => r.json())
      .then(geo => {
        geoLayer = L.geoJSON(geo, {
          pane: 'polygons',
          style: () => styleBase,
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const nome = p.name || p['descrição'] || p['descricao'] || 'Subsetor';
            const codigo = p.CODIGO || '';
            const cia = p.CIA || '';
            const ueop = p.UEOP_2 || '';
            const rpm = p.RPM || '';
            layer.bindPopup(`<b>${nome}</b><br>${codigo}<br>${cia}<br>${ueop}<br>${rpm}`);
            // hover
            layer.on({
              mouseover: e => e.target.setStyle({ weight: 3, fillOpacity: 0.35 }),
              mouseout:  e => geoLayer.resetStyle(e.target)
            });
          }
        }).addTo(map);

        // Enquadra tudo
        map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
      })
      .catch(err => console.error('Erro GeoJSON:', err));

    // Botão "Ir" (vai para lat/lng digitado e abre popup se cair num subsetor)
    document.getElementById('btnIr').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        const ll = [lat, lng];
        map.setView(ll, 14);
        marcaUsuario(ll, 'Coordenada informada');
        abrePopupSeDentro(ll);
      }
    });

    // Geolocalização
    document.getElementById('btnLoc').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocalização não suportada.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = [pos.coords.latitude, pos.coords.longitude];
          map.setView(ll, 15);
          marcaUsuario(ll, 'Você está aqui');
          abrePopupSeDentro(ll);
        },
        err => alert('Não foi possível obter a localização: ' + err.message),
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });

    function marcaUsuario(latlng, texto){
      if (userMarker) userMarker.remove();
      userMarker = L.marker(latlng).addTo(map).bindPopup(texto).openPopup();
    }

    // Verifica se o ponto está dentro de algum polígono e abre o popup
    function abrePopupSeDentro(latlng){
      if (!geoLayer) return;
      let found = null;
      geoLayer.eachLayer(layer => {
        if (!layer.getBounds) return;
        // teste rápido de bbox + ponto em polígono
        if (layer.getBounds().contains(latlng) && pontoNoPoligono(latlng, layer)){
          found = layer;
        }
      });
      if (found){
        found.openPopup();
      }
    }

    // Ray casting simples usando os coords do layer
    function pontoNoPoligono(latlng, layer){
      const pt = { x: latlng[1], y: latlng[0] }; // x=lng, y=lat
      const gj = layer.feature.geometry;
      // suporta Polygon e MultiPolygon
      const polys = (gj.type === 'Polygon') ? [gj.coordinates] : (gj.type === 'MultiPolygon' ? gj.coordinates : []);
      let inside = false;

      polys.forEach(poly => {
        // considera apenas o anel externo
        const ring = poly[0].map(([lng, lat]) => ({ x: lng, y: lat }));
        let c = false;
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++){
          const xi = ring[i].x, yi = ring[i].y;
          const xj = ring[j].x, yj = ring[j].y;
          const intersect = ((yi > pt.y) !== (yj > pt.y)) &&
                            (pt.x < (xj - xi) * (pt.y - yi) / (yj - yi + 0.0) + xi);
          if (intersect) c = !c;
        }
        if (c) inside = true;
      });
      return inside;
    }

    // PWA: registra o SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
